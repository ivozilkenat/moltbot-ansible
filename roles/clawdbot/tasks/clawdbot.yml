---
- name: Create Clawdbot directories (structure only, no config files)
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: "{{ item.mode }}"
  loop:
    - { path: "{{ clawdbot_config_dir }}", mode: '0700' }
    - { path: "{{ clawdbot_config_dir }}/sessions", mode: '0755' }
    - { path: "{{ clawdbot_config_dir }}/credentials", mode: '0700' }
    - { path: "{{ clawdbot_config_dir }}/data", mode: '0755' }
    - { path: "{{ clawdbot_config_dir }}/logs", mode: '0755' }

# Create workspace directory for agents
- name: Create clawdbot workspace directory
  ansible.builtin.file:
    path: "{{ clawdbot_home }}/clawd"
    state: directory
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0755'

# Generate gateway token if not provided
- name: Generate gateway token if not set
  ansible.builtin.set_fact:
    clawdbot_gateway_token: "{{ lookup('password', '/dev/null chars=ascii_lowercase,digits length=48') }}"
  when: clawdbot_gateway_token == ""
  no_log: true

# Backup existing config if present and force_config is true
- name: Check if clawdbot.json already exists
  ansible.builtin.stat:
    path: "{{ clawdbot_config_dir }}/clawdbot.json"
  register: existing_config

- name: Backup existing clawdbot.json (with timestamp)
  ansible.builtin.copy:
    src: "{{ clawdbot_config_dir }}/clawdbot.json"
    dest: "{{ clawdbot_config_dir }}/clawdbot.json.backup.{{ ansible_date_time.iso8601_basic_short }}"
    remote_src: true
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0600'
  when: existing_config.stat.exists and clawdbot_force_config

# Deploy clawdbot.json configuration
- name: Deploy clawdbot.json configuration
  ansible.builtin.template:
    src: clawdbot-config.json.j2
    dest: "{{ clawdbot_config_dir }}/clawdbot.json"
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0600'
  when: not existing_config.stat.exists or clawdbot_force_config
  notify: Restart clawdbot gateway

- name: Create pnpm directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0755'
  loop:
    - "{{ clawdbot_home }}/.local/share/pnpm"
    - "{{ clawdbot_home }}/.local/share/pnpm/store"
    - "{{ clawdbot_home }}/.local/bin"

- name: Ensure pnpm directories have correct ownership
  ansible.builtin.file:
    path: "{{ clawdbot_home }}/.local/share/pnpm"
    state: directory
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    recurse: true
    mode: '0755'

- name: Configure pnpm for clawdbot user
  ansible.builtin.shell:
    cmd: |
      pnpm config set global-dir {{ clawdbot_home }}/.local/share/pnpm
      pnpm config set global-bin-dir {{ clawdbot_home }}/.local/bin
    executable: /bin/bash
  become: true
  become_user: "{{ clawdbot_user }}"
  changed_when: true  # Always consider changed as pnpm config may update

- name: Display installation mode
  ansible.builtin.debug:
    msg: "ğŸ“¦ Installation mode: {{ clawdbot_install_mode }}"

# Include appropriate installation method based on mode
- name: Include release installation (pnpm install -g)
  ansible.builtin.include_tasks: clawdbot-release.yml
  when: clawdbot_install_mode == "release"

- name: Include development installation (git clone + build + link)
  ansible.builtin.include_tasks: clawdbot-development.yml
  when: clawdbot_install_mode == "development"

- name: Configure .bashrc for clawdbot user (base config)
  ansible.builtin.blockinfile:
    path: "{{ clawdbot_home }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - Clawdbot pnpm"
    block: |
      # pnpm configuration
      export PNPM_HOME="{{ clawdbot_home }}/.local/share/pnpm"
      export PATH="{{ clawdbot_home }}/.local/bin:$PNPM_HOME:$PATH"
    create: true
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0644'
    insertafter: EOF

# Install gateway daemon (systemd service on Linux, launchd on macOS)
- name: Install clawdbot gateway
  ansible.builtin.shell:
    cmd: clawdbot gateway install
  become: true
  become_user: "{{ clawdbot_user }}"
  environment:
    PATH: "{{ clawdbot_path }}"
    HOME: "{{ clawdbot_home }}"
    XDG_RUNTIME_DIR: "{{ '/run/user/' + clawdbot_uid_value if clawdbot_uid_value is defined else '' }}"
    DBUS_SESSION_BUS_ADDRESS: "{{ 'unix:path=/run/user/' + clawdbot_uid_value + '/bus' if clawdbot_uid_value is defined else '' }}"
  register: gateway_install
  changed_when: "'installed' in gateway_install.stdout or gateway_install.rc == 0"

# Start gateway daemon
- name: Start clawdbot gateway
  ansible.builtin.shell:
    cmd: clawdbot gateway start
  become: true
  become_user: "{{ clawdbot_user }}"
  environment:
    PATH: "{{ clawdbot_path }}"
    HOME: "{{ clawdbot_home }}"
    XDG_RUNTIME_DIR: "{{ '/run/user/' + clawdbot_uid_value if clawdbot_uid_value is defined else '' }}"
    DBUS_SESSION_BUS_ADDRESS: "{{ 'unix:path=/run/user/' + clawdbot_uid_value + '/bus' if clawdbot_uid_value is defined else '' }}"
  when: clawdbot_start_daemon
  register: gateway_start
  changed_when: "'started' in gateway_start.stdout or gateway_start.rc == 0"
  ignore_errors: true  # May already be running

# Verify gateway is running
- name: Check gateway status
  ansible.builtin.shell:
    cmd: clawdbot gateway status
  become: true
  become_user: "{{ clawdbot_user }}"
  environment:
    PATH: "{{ clawdbot_path }}"
    HOME: "{{ clawdbot_home }}"
    XDG_RUNTIME_DIR: "{{ '/run/user/' + clawdbot_uid_value if clawdbot_uid_value is defined else '' }}"
    DBUS_SESSION_BUS_ADDRESS: "{{ 'unix:path=/run/user/' + clawdbot_uid_value + '/bus' if clawdbot_uid_value is defined else '' }}"
  register: gateway_status
  changed_when: false
  ignore_errors: true

- name: Display dashboard info
  ansible.builtin.debug:
    msg: |
      âœ… Clawdbot Gateway is installed and running!

      â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      â•‘         Dashboard Ready                                â•‘
      â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      Dashboard URL: http://<server-ip>:{{ clawdbot_gateway_port }}/

      Auth Token (paste in dashboard settings):
        {{ clawdbot_gateway_token }}

      Next Steps:
      1. Open the dashboard URL in your browser
      2. Paste the auth token in settings
      3. Connect a messaging provider (WhatsApp, Telegram, etc.)
      4. Configure AI model API keys

      Quick Commands (as clawdbot user):
        clawdbot gateway status     # Check gateway status
        clawdbot providers login    # Connect messaging provider
        clawdbot config set <k> <v> # Change settings
        clawdbot security audit     # Security check
