---
# Create pnpm directories
- name: Create pnpm directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0755'
  loop:
    - "{{ clawdbot_home }}/.local/share/pnpm"
    - "{{ clawdbot_home }}/.local/share/pnpm/store"
    - "{{ clawdbot_home }}/.local/bin"

- name: Configure pnpm for clawdbot user
  ansible.builtin.shell:
    cmd: |
      pnpm config set global-dir {{ clawdbot_home }}/.local/share/pnpm
      pnpm config set global-bin-dir {{ clawdbot_home }}/.local/bin
    executable: /bin/bash
  become: true
  become_user: "{{ clawdbot_user }}"
  changed_when: true  # Always consider changed as pnpm config may update

# Include appropriate installation method based on mode
- name: Include release installation (pnpm install -g)
  ansible.builtin.include_tasks: clawdbot-release.yml
  when: clawdbot_install_mode == "release"

- name: Include development installation (git clone + build + link)
  ansible.builtin.include_tasks: clawdbot-development.yml
  when: clawdbot_install_mode == "development"

- name: Configure .bashrc for clawdbot user
  ansible.builtin.blockinfile:
    path: "{{ clawdbot_home }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - Moltbot pnpm"
    block: |
      # pnpm configuration
      export PNPM_HOME="{{ clawdbot_home }}/.local/share/pnpm"
      export PATH="{{ clawdbot_home }}/.local/bin:$PNPM_HOME:$PATH"
    create: true
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0644'
    insertafter: EOF

# Display Moltbot-style greeting with wizard instructions
- name: Display Moltbot installation complete message
  ansible.builtin.debug:
    msg: |
      
      ░███░░░░█░░░░░███░░█░░░░████░░████░░███░░▀█▀
      █░░░█░░█░░░░░█░░░█░█░░░░█░░░█░█░░░█░░█░░░░█░
      █░░░█░░█░░░░░█░░░█░█░░░░████░░█░░░█░░█░░░░█░
      █░░░█░░█░░░░░█░░░█░█░░░░█░░░█░█░░░█░░█░░░░█░
      ░███░░░█████░░███░░█████████░░████░░░█░░░░█░
                    FRESH DAILY
      
      Moltbot is installed!
      
      To complete setup, log in as the moltbot user and run the wizard:
      
        sudo -i -u {{ clawdbot_user }}
        moltbot onboard --install-daemon
      
      The wizard will walk you through:
        - Gateway configuration
        - Workspace setup
        - Channel connections (WhatsApp, Telegram, Discord, etc.)
        - Skills configuration
      
      Docs: https://docs.molt.bot
      GitHub: https://github.com/moltbot/moltbot
