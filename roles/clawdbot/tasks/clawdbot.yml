---
# Create pnpm directories
- name: Create pnpm directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0755'
  loop:
    - "{{ clawdbot_home }}/.local/share/pnpm"
    - "{{ clawdbot_home }}/.local/share/pnpm/store"
    - "{{ clawdbot_home }}/.local/bin"

- name: Configure pnpm for clawdbot user
  ansible.builtin.shell:
    cmd: |
      pnpm config set global-dir {{ clawdbot_home }}/.local/share/pnpm
      pnpm config set global-bin-dir {{ clawdbot_home }}/.local/bin
    executable: /bin/bash
  become: true
  become_user: "{{ clawdbot_user }}"
  changed_when: true  # Always consider changed as pnpm config may update

# Include appropriate installation method based on mode
- name: Include release installation (pnpm install -g)
  ansible.builtin.include_tasks: clawdbot-release.yml
  when: clawdbot_install_mode == "release"

- name: Include development installation (git clone + build + link)
  ansible.builtin.include_tasks: clawdbot-development.yml
  when: clawdbot_install_mode == "development"

- name: Deploy zshrc for clawdbot user
  ansible.builtin.template:
    src: zshrc-clawdbot.j2
    dest: "{{ clawdbot_home }}/.zshrc"
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0644'

- name: Generate gateway token if not set
  ansible.builtin.set_fact:
    clawdbot_gateway_token: "{{ lookup('community.general.random_string', length=64, base64=false, special=false) }}"
  when: clawdbot_gateway_token | length == 0

- name: Initialize clawdbot config directories
  ansible.builtin.shell:
    cmd: "{{ clawdbot_bin }} setup"
  become: true
  become_user: "{{ clawdbot_user }}"
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ clawdbot_uid_value }}"
    DBUS_SESSION_BUS_ADDRESS: "unix:path=/run/user/{{ clawdbot_uid_value }}/bus"
  args:
    creates: "{{ clawdbot_config_dir }}/clawdbot.json"

- name: Install clawdbot gateway service
  ansible.builtin.shell:
    cmd: "{{ clawdbot_bin }} gateway install --force"
  become: true
  become_user: "{{ clawdbot_user }}"
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ clawdbot_uid_value }}"
    DBUS_SESSION_BUS_ADDRESS: "unix:path=/run/user/{{ clawdbot_uid_value }}/bus"

- name: Configure gateway settings
  ansible.builtin.shell:
    cmd: |
      {{ clawdbot_bin }} config set gateway.mode {{ clawdbot_gateway_mode }}
      {{ clawdbot_bin }} config set gateway.bind {{ clawdbot_gateway_bind }}
      {{ clawdbot_bin }} config set gateway.auth.token "{{ clawdbot_gateway_token }}"
  become: true
  become_user: "{{ clawdbot_user }}"
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ clawdbot_uid_value }}"
    DBUS_SESSION_BUS_ADDRESS: "unix:path=/run/user/{{ clawdbot_uid_value }}/bus"

- name: Create trusted proxies config script
  ansible.builtin.copy:
    dest: /tmp/set_proxies.sh
    content: |
      {{ clawdbot_bin }} config set --json gateway.trustedProxies '{{ clawdbot_trusted_proxies | to_json }}'
    mode: '0755'

- name: Set trusted proxies
  ansible.builtin.shell:
    cmd: bash /tmp/set_proxies.sh
  become: true
  become_user: "{{ clawdbot_user }}"
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ clawdbot_uid_value }}"
    DBUS_SESSION_BUS_ADDRESS: "unix:path=/run/user/{{ clawdbot_uid_value }}/bus"

- name: Start clawdbot gateway
  ansible.builtin.shell:
    cmd: "{{ clawdbot_bin }} gateway restart"
  become: true
  become_user: "{{ clawdbot_user }}"
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ clawdbot_uid_value }}"
    DBUS_SESSION_BUS_ADDRESS: "unix:path=/run/user/{{ clawdbot_uid_value }}/bus"
  when: clawdbot_start_daemon | bool

- name: Verify gateway is running
  ansible.builtin.shell:
    cmd: "{{ clawdbot_bin }} gateway status"
  become: true
  become_user: "{{ clawdbot_user }}"
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ clawdbot_uid_value }}"
    DBUS_SESSION_BUS_ADDRESS: "unix:path=/run/user/{{ clawdbot_uid_value }}/bus"
  register: gateway_status
  when: clawdbot_start_daemon | bool

- name: Display gateway status
  ansible.builtin.debug:
    msg: "{{ gateway_status.stdout_lines }}"
  when: clawdbot_start_daemon | bool and gateway_status is defined

- name: Configure .bashrc for clawdbot user
  ansible.builtin.blockinfile:
    path: "{{ clawdbot_home }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - Moltbot pnpm"
    block: |
      # pnpm configuration
      export PNPM_HOME="{{ clawdbot_home }}/.local/share/pnpm"
      export PATH="{{ clawdbot_home }}/.local/bin:$PNPM_HOME:$PATH"
    create: true
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0644'
    insertafter: EOF

# Display Moltbot-style greeting with wizard instructions
- name: Display Moltbot installation complete message
  ansible.builtin.debug:
    msg: |
      
      ░███░░░░█░░░░░███░░█░░░░████░░████░░███░░▀█▀
      █░░░█░░█░░░░░█░░░█░█░░░░█░░░█░█░░░█░░█░░░░█░
      █░░░█░░█░░░░░█░░░█░█░░░░████░░█░░░█░░█░░░░█░
      █░░░█░░█░░░░░█░░░█░█░░░░█░░░█░█░░░█░░█░░░░█░
      ░███░░░█████░░███░░█████████░░████░░░█░░░░█░
                    FRESH DAILY
      
      Clawdbot is installed and configured!
      
      Gateway is running on port {{ clawdbot_gateway_port }}.
      
      To complete setup, log in as the clawdbot user and run the wizard:
      
        sudo -i -u {{ clawdbot_user }}
        clawdbot onboard --no-install-daemon
      
      The wizard will walk you through:
        - Workspace setup
        - Channel connections (WhatsApp, Telegram, Discord, etc.)
        - Skills configuration
      
      Docs: https://docs.clawd.bot
      GitHub: https://github.com/clawdbot/clawdbot
