---
# Linux-specific Tailscale installation (Debian/Ubuntu)

- name: Add Tailscale GPG key
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      DIST="{{ ansible_distribution | lower }}"
      RELEASE="{{ ansible_distribution_release }}"
      curl -fsSL "https://pkgs.tailscale.com/stable/${DIST}/${RELEASE}.noarmor.gpg" | \
        tee /usr/share/keyrings/tailscale-archive-keyring.gpg > /dev/null
    creates: /usr/share/keyrings/tailscale-archive-keyring.gpg
    executable: /bin/bash

- name: Add Tailscale repository
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      DIST="{{ ansible_distribution | lower }}"
      RELEASE="{{ ansible_distribution_release }}"
      curl -fsSL "https://pkgs.tailscale.com/stable/${DIST}/${RELEASE}.tailscale-keyring.list" | \
        tee /etc/apt/sources.list.d/tailscale.list > /dev/null
    creates: /etc/apt/sources.list.d/tailscale.list
    executable: /bin/bash

- name: Update apt cache after adding Tailscale repo
  ansible.builtin.apt:
    update_cache: true

- name: Install Tailscale
  ansible.builtin.apt:
    name: tailscale
    state: present

- name: Enable Tailscale service (Linux)
  ansible.builtin.systemd:
    name: tailscaled
    enabled: true
    state: started

- name: Connect Tailscale with auth key
  ansible.builtin.shell:
    cmd: |
      tailscale up --authkey {{ tailscale_authkey }} \
        {{ '--hostname ' + tailscale_hostname if tailscale_hostname else '' }} \
        {{ '--login-server ' + tailscale_login_server if tailscale_login_server else '' }}
    executable: /bin/bash
  when: tailscale_authkey | length > 0

- name: Display Tailscale manual connection instructions
  ansible.builtin.debug:
    msg:
      - "Tailscale installed but not connected (no authkey provided)"
      - "To connect manually: sudo tailscale up --login-server {{ tailscale_login_server }}"
  when: tailscale_authkey | length == 0
