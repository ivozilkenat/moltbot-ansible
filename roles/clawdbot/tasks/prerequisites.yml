---
# Prerequisites and OS detection tasks
# These tasks detect the OS, update packages, and install Homebrew

- name: Detect operating system
  ansible.builtin.set_fact:
    is_macos: "{{ ansible_os_family == 'Darwin' }}"
    is_linux: "{{ ansible_os_family == 'Debian' }}"
    is_debian: "{{ ansible_distribution in ['Debian', 'Ubuntu'] }}"
    is_redhat: "{{ ansible_os_family == 'RedHat' }}"

- name: Display detected OS
  ansible.builtin.debug:
    msg: |
      Detected OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
      OS Family: {{ ansible_os_family }}
      macOS: {{ is_macos }}
      Linux (Debian/Ubuntu): {{ is_debian }}
      Linux (RedHat/CentOS): {{ is_redhat }}

- name: Update apt cache and upgrade all packages (Debian/Ubuntu)
  ansible.builtin.apt:
    update_cache: true
    upgrade: dist
    cache_valid_time: 3600
  when: is_debian
  register: apt_upgrade_result

- name: Display apt upgrade results
  ansible.builtin.debug:
    msg: "✅ System packages updated and upgraded"
  when: is_debian and apt_upgrade_result.changed

- name: Check if Homebrew is installed
  ansible.builtin.stat:
    path: "{{ '/opt/homebrew/bin/brew' if is_macos else '/home/linuxbrew/.linuxbrew/bin/brew' }}"
  register: homebrew_check

- name: Create Homebrew directory for Linux
  ansible.builtin.file:
    path: /home/linuxbrew
    state: directory
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0755'
  when: is_linux and not homebrew_check.stat.exists

- name: Install Homebrew as clawdbot user (Linux)
  ansible.builtin.shell: |
    su - {{ clawdbot_user }} -c 'NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"'
  args:
    creates: /home/linuxbrew/.linuxbrew/bin/brew
  when: is_linux and not homebrew_check.stat.exists
  register: homebrew_install_linux

- name: Install Homebrew (macOS)
  ansible.builtin.shell: |
    NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  become: false
  args:
    creates: /opt/homebrew/bin/brew
  when: is_macos and not homebrew_check.stat.exists
  register: homebrew_install_macos

- name: Add Homebrew to PATH for current session (Linux)
  ansible.builtin.set_fact:
    ansible_env: "{{ ansible_env | combine({'PATH': '/home/linuxbrew/.linuxbrew/bin:' + ansible_env.PATH}) }}"
  when: is_linux and not is_macos

- name: Add Homebrew to PATH for current session (macOS)
  ansible.builtin.set_fact:
    ansible_env: "{{ ansible_env | combine({'PATH': '/opt/homebrew/bin:' + ansible_env.PATH}) }}"
  when: is_macos

- name: Display Homebrew installation status
  ansible.builtin.debug:
    msg: "✅ Homebrew installed successfully"
  when: (homebrew_install_linux is defined and homebrew_install_linux.changed) or (homebrew_install_macos is defined and homebrew_install_macos.changed)
