---
# Main system tools orchestration - delegates to OS-specific tasks

- name: Include Linux system tools installation
  ansible.builtin.include_tasks: system-tools-linux.yml
  when: ansible_os_family == 'Debian'

- name: Include macOS system tools installation
  ansible.builtin.include_tasks: system-tools-macos.yml
  when: ansible_os_family == 'Darwin'

- name: Display unsupported OS warning
  ansible.builtin.fail:
    msg: "Unsupported OS family: {{ ansible_os_family }}. Only Debian/Ubuntu and macOS are supported."
  when: ansible_os_family not in ['Debian', 'Darwin']

# Common tasks for all operating systems

- name: Install oh-my-zsh for clawdbot user
  ansible.builtin.shell:
    cmd: |
      sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
    creates: "{{ clawdbot_home }}/.oh-my-zsh"
    executable: /bin/bash
  become: true
  become_user: "{{ clawdbot_user }}"
  environment:
    HOME: "{{ clawdbot_home }}"
    USER: "{{ clawdbot_user }}"

- name: Check if .zshrc has oh-my-zsh configuration
  ansible.builtin.stat:
    path: "{{ clawdbot_home }}/.zshrc"
  register: zshrc_stat

- name: Check if .zshrc contains ZSH_THEME (oh-my-zsh marker)
  ansible.builtin.shell:
    cmd: grep -q "ZSH_THEME" "{{ clawdbot_home }}/.zshrc" 2>/dev/null || echo "missing"
  register: zshrc_has_ohmyzsh
  changed_when: false
  failed_when: false
  when: zshrc_stat.stat.exists

- name: Restore oh-my-zsh .zshrc template if corrupted
  ansible.builtin.copy:
    src: "{{ clawdbot_home }}/.oh-my-zsh/templates/zshrc.zsh-template"
    dest: "{{ clawdbot_home }}/.zshrc"
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0644'
    remote_src: true
  when: zshrc_stat.stat.exists and zshrc_has_ohmyzsh.stdout == "missing"

- name: Configure .zshrc for clawdbot user (after oh-my-zsh)
  ansible.builtin.blockinfile:
    path: "{{ clawdbot_home }}/.zshrc"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - Clawdbot config"
    block: "{{ lookup('template', 'zshrc-clawdbot.j2') }}"
    create: true
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0644'

- name: Configure git globally
  community.general.git_config:
    name: "{{ item.name }}"
    scope: global
    value: "{{ item.value }}"
  loop:
    - { name: 'init.defaultBranch', value: 'main' }
    - { name: 'pull.rebase', value: 'false' }
    - { name: 'core.editor', value: 'vim' }
    - { name: 'color.ui', value: 'auto' }
    - { name: 'alias.st', value: 'status' }
    - { name: 'alias.co', value: 'checkout' }
    - { name: 'alias.br', value: 'branch' }
    - { name: 'alias.ci', value: 'commit' }
    - { name: 'alias.unstage', value: 'reset HEAD --' }
    - { name: 'alias.last', value: 'log -1 HEAD' }
    - { name: 'alias.lg', value: 'log --oneline --graph --decorate --all' }
